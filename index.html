<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能记账小助手</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- sql.js -->
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>
    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-container {
            width: 100%;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f3f4f6;
        }
        
        .upload-area.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .upload-area.drag-over .upload-icon i {
            color: #3b82f6;
            transform: scale(1.1);
            transition: all 0.3s ease;
        }
        
        .loading-spinner {
            display: flex;
            align-items: center;
        }
        
        .loading-spinner i {
            font-size: 1.2rem;
        }
        
        #errorMessage {
            font-size: 0.9rem;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-gray-800">智能记账小助手</h1>
            <p class="text-gray-600 text-center mt-2">轻松管理您的日常支出</p>
        </header>
        
        <div class="bg-white rounded-lg shadow-md p-4 mb-8">
            <div class="flex border-b">
                <button class="tab-btn active px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600" data-tab="upload">上传账单</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-600 hover:text-blue-600" data-tab="records">账单记录</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-600 hover:text-blue-600" data-tab="categories">分类管理</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-600 hover:text-blue-600" data-tab="statistics">统计分析</button>
                <button class="tab-btn px-4 py-2 font-medium text-gray-600 hover:text-blue-600" data-tab="backup">数据备份</button>
            </div>
            
            <div class="tab-content active" id="upload">
                <div class="py-6">
                    <h2 class="text-xl font-semibold mb-4">上传账单图片</h2>
                    <div class="upload-container">
                        <div class="upload-area rounded-lg p-8 text-center" id="uploadArea">
                            <div class="upload-icon">
                                <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-4"></i>
                            </div>
                            <p class="text-gray-600 mb-2">点击或拖拽图片到此处上传</p>
                            <p class="text-gray-400 text-sm">支持 JPG、PNG、WEBP 格式</p>
                            <button id="browseBtn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                <i class="fa fa-folder-open mr-2"></i>选择图片
                            </button>
                            <input type="file" id="fileInput" class="hidden" accept="image/*">
                            <div id="errorMessage" class="mt-4 text-red-600 hidden"></div>
                        </div>
                        
                        <div id="previewContainer" class="mt-6 hidden">
                            <h3 class="text-lg font-medium mb-2">预览</h3>
                            <div class="flex items-center justify-center mb-4">
                                <img id="previewImage" class="max-h-64 object-contain" src="" alt="预览">
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <p id="fileName" class="text-gray-600"></p>
                                <div class="loading-spinner hidden" id="loadingSpinner">
                                    <i class="fa fa-spinner fa-spin text-blue-600"></i>
                                    <span class="ml-2 text-gray-600">处理中...</span>
                                </div>
                            </div>
                            <div class="progress-bar mb-4 hidden" id="progressBar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <p id="progressText" class="text-gray-600 mb-4 hidden">识别中...</p>
                        </div>
                    </div>
                    
                    <div id="resultContainer" class="mt-6 hidden">
                        <h3 class="text-lg font-medium mb-2">识别结果</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                                <input type="date" id="dateInput" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">金额</label>
                                <input type="number" id="amountInput" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                                <input type="text" id="descriptionInput" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                                <select id="categorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">请选择分类</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="saveRecordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">保存记录</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="records">
                <div class="py-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">账单记录</h2>
                        <div class="flex items-center">
                            <select id="monthFilter" class="px-3 py-2 border border-gray-300 rounded-md mr-2">
                                <option value="all">全部月份</option>
                            </select>
                            <button id="refreshRecordsBtn" class="bg-gray-200 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-300">
                                <i class="fa fa-refresh mr-1"></i> 刷新
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                    <th class="px-6 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                    <th class="px-6 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="recordsTableBody">
                                <!-- 记录将通过 JavaScript 动态添加 -->
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无记录</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="categories">
                <div class="py-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">分类管理</h2>
                        <button id="addCategoryBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            <i class="fa fa-plus mr-1"></i> 添加分类
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="categoriesContainer">
                        <!-- 分类将通过 JavaScript 动态添加 -->
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="statistics">
                <div class="py-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">统计分析</h2>
                        <select id="statMonthFilter" class="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">全部月份</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="card bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-600">总支出</h3>
                            <p class="text-2xl font-bold text-blue-600" id="totalExpense">¥0.00</p>
                        </div>
                        <div class="card bg-green-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-600">平均支出</h3>
                            <p class="text-2xl font-bold text-green-600" id="averageExpense">¥0.00</p>
                        </div>
                        <div class="card bg-purple-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-600">支出分类</h3>
                            <p class="text-2xl font-bold text-purple-600" id="categoryCount">0</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-4">支出分类占比</h3>
                            <canvas id="categoryChart" height="300"></canvas>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-4">月度支出趋势</h3>
                            <canvas id="trendChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="backup">
                <div class="py-6">
                    <h2 class="text-xl font-semibold mb-4">数据备份</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-4">导出数据</h3>
                            <p class="text-gray-600 mb-4">将您的记账数据导出为 JSON 文件</p>
                            <button id="exportDataBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 w-full">
                                <i class="fa fa-download mr-1"></i> 导出数据
                            </button>
                        </div>
                        <div class="card bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-4">导入数据</h3>
                            <p class="text-gray-600 mb-4">从 JSON 文件导入记账数据</p>
                            <div class="border border-gray-300 rounded-md p-4 mb-4">
                                <input type="file" id="importFileInput" class="hidden" accept=".json">
                                <button id="importDataBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 w-full">
                                    <i class="fa fa-upload mr-1"></i> 选择文件
                                </button>
                            </div>
                            <p id="importStatus" class="text-sm text-gray-500 hidden">请选择要导入的文件</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="mt-8 text-center text-gray-600 text-sm">
            <p>© 2026 智能记账小助手 - 轻松管理您的财务</p>
        </footer>
    </div>
    
    <!-- 添加/编辑分类模态框 -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
            <h3 class="text-xl font-semibold mb-4" id="modalTitle">添加分类</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">分类名称</label>
                    <input type="text" id="categoryName" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">分类颜色</label>
                    <input type="color" id="categoryColor" class="w-full h-10 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">匹配规则 (正则表达式)</label>
                    <input type="text" id="categoryRule" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="例如: .*餐厅.*">
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancelModalBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                <button id="saveCategoryBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">保存</button>
            </div>
        </div>
    </div>
    
    <script>
        // 全局变量
        let db;
        let currentCategoryId = null;
        
        // 初始化
        async function init() {
            await initDatabase();
            loadCategories();
            loadRecords();
            updateStatistics();
            setupEventListeners();
        }
        
        // 初始化数据库
        async function initDatabase() {
            // 加载 sql.js
            const SQL = await initSqlJs({
                locateFile: filename => `https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/${filename}`
            });
            
            // 创建内存数据库
            db = new SQL.Database();
            
            // 创建表结构
            db.run(`
                CREATE TABLE IF NOT EXISTS categories (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    color TEXT DEFAULT '#3b82f6',
                    rule TEXT DEFAULT ''
                );
                
                CREATE TABLE IF NOT EXISTS records (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    date TEXT NOT NULL,
                    description TEXT NOT NULL,
                    amount REAL NOT NULL,
                    category_id INTEGER,
                    FOREIGN KEY (category_id) REFERENCES categories (id)
                );
            `);
            
            // 插入预设分类
            const defaultCategories = [
                { name: '餐饮', color: '#ef4444', rule: '.*餐厅.*|.*饭店.*|.*小吃.*|.*外卖.*' },
                { name: '交通', color: '#3b82f6', rule: '.*公交.*|.*地铁.*|.*出租车.*|.*打车.*|.*加油.*' },
                { name: '购物', color: '#8b5cf6', rule: '.*超市.*|.*商场.*|.*购物.*|.*淘宝.*|.*京东.*' },
                { name: '娱乐', color: '#f59e0b', rule: '.*电影.*|.*游戏.*|.*娱乐.*|.*休闲.*' },
                { name: '医疗', color: '#10b981', rule: '.*医院.*|.*药店.*|.*医疗.*' },
                { name: '教育', color: '#6366f1', rule: '.*学校.*|.*教育.*|.*培训.*|.*学习.*' },
                { name: '其他', color: '#6b7280', rule: '' }
            ];
            
            // 检查是否已有分类
            const result = db.exec('SELECT COUNT(*) as count FROM categories');
            if (result[0].values[0][0] === 0) {
                defaultCategories.forEach(category => {
                    db.run('INSERT INTO categories (name, color, rule) VALUES (?, ?, ?)', [category.name, category.color, category.rule]);
                });
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 标签页切换
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    
                    // 更新标签按钮状态
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.remove('active', 'text-blue-600', 'border-b-2', 'border-blue-600');
                        b.classList.add('text-gray-600');
                    });
                    btn.classList.add('active', 'text-blue-600', 'border-b-2', 'border-blue-600');
                    
                    // 更新标签内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // 切换到统计标签时更新数据
                    if (tabId === 'statistics') {
                        updateStatistics();
                    }
                });
            });
            
            // 上传区域点击
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            
            uploadArea.addEventListener('click', (e) => {
                // 确保点击的不是隐藏的 input 元素和浏览按钮
                if (e.target !== fileInput && e.target !== browseBtn) {
                    fileInput.click();
                }
            });
            
            // 浏览按钮点击
            browseBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            
            // 阻止默认行为，防止拖拽文件时在浏览器中打开
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // 只有当鼠标离开整个上传区域时才移除 drag-over 类
                if (e.currentTarget.contains(e.relatedTarget)) {
                    return;
                }
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            // 文件选择
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // 保存记录
            document.getElementById('saveRecordBtn').addEventListener('click', saveRecord);
            
            // 刷新记录
            document.getElementById('refreshRecordsBtn').addEventListener('click', loadRecords);
            
            // 月份筛选
            document.getElementById('monthFilter').addEventListener('change', loadRecords);
            document.getElementById('statMonthFilter').addEventListener('change', updateStatistics);
            
            // 添加分类
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                currentCategoryId = null;
                document.getElementById('modalTitle').textContent = '添加分类';
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryColor').value = '#3b82f6';
                document.getElementById('categoryRule').value = '';
                document.getElementById('categoryModal').classList.remove('hidden');
            });
            
            // 取消模态框
            document.getElementById('cancelModalBtn').addEventListener('click', () => {
                document.getElementById('categoryModal').classList.add('hidden');
            });
            
            // 保存分类
            document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
            
            // 导出数据
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            
            // 导入数据
            document.getElementById('importDataBtn').addEventListener('click', () => {
                document.getElementById('importFileInput').click();
            });
            
            document.getElementById('importFileInput').addEventListener('change', handleImportFile);
        }
        
        // 处理文件
        function handleFile(file) {
            // 重置错误信息
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
            
            // 验证文件类型
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                errorMessage.textContent = '仅支持 JPG/PNG/WEBP 格式';
                errorMessage.classList.remove('hidden');
                return;
            }
            
            // 验证文件大小（10 MB）
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                errorMessage.textContent = '文件大小不能超过 10MB';
                errorMessage.classList.remove('hidden');
                return;
            }
            
            // 显示文件名
            const fileName = document.getElementById('fileName');
            fileName.textContent = `文件名: ${file.name}`;
            
            // 显示预览
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            previewContainer.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                
                // 开始 OCR 识别
                recognizeText(e.target.result, file.name);
            };
            
            reader.onerror = () => {
                errorMessage.textContent = '图片上传失败，请重试';
                errorMessage.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            };
            
            reader.readAsDataURL(file);
        }
        
        // OCR 识别
        async function recognizeText(imageData, fileName) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultContainer = document.getElementById('resultContainer');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // 显示进度条
            progressBar.classList.remove('hidden');
            progressText.classList.remove('hidden');
            
            try {
                // 导入 Tesseract.js
                const { createWorker } = await import('https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.mjs');
                const worker = createWorker({ langPath: 'https://tessdata.projectnaptha.com/4.0.0' });
                
                await worker.load();
                await worker.loadLanguage('chi_sim');
                await worker.initialize('chi_sim');
                
                // 识别
                const { data: { text } } = await worker.recognize(imageData, {
                    progress: (info) => {
                        const progress = Math.round(info.progress * 100);
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `识别中... ${progress}%`;
                    }
                });
                
                await worker.terminate();
                
                // 处理识别结果
                processOcrResult(text);
                
                // 显示结果容器
                resultContainer.classList.remove('hidden');
            } catch (error) {
                console.error('OCR 识别失败:', error);
                progressText.textContent = '识别失败，请重试';
                progressText.classList.add('text-red-600');
            } finally {
                // 隐藏加载动画和进度条
                loadingSpinner.classList.add('hidden');
                setTimeout(() => {
                    progressBar.classList.add('hidden');
                    progressText.classList.add('hidden');
                }, 500);
            }
        }
        
        // 处理 OCR 结果
        function processOcrResult(text) {
            console.log('OCR 识别结果:', text);
            
            // 简单的结果处理逻辑
            // 提取日期
            const dateMatch = text.match(/(\d{4})[年\/\-](\d{1,2})[月\/\-](\d{1,2})[日]?/);
            if (dateMatch) {
                const [, year, month, day] = dateMatch;
                const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                document.getElementById('dateInput').value = formattedDate;
            } else {
                // 默认今天
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                document.getElementById('dateInput').value = formattedDate;
            }
            
            // 提取金额
            const amountMatch = text.match(/金额[：:]*\s*¥?\s*(\d+\.?\d*)/) || text.match(/¥\s*(\d+\.?\d*)/);
            if (amountMatch) {
                document.getElementById('amountInput').value = amountMatch[1];
            }
            
            // 提取描述
            document.getElementById('descriptionInput').value = text.substring(0, 50);
            
            // 自动分类
            autoCategorize(text);
        }
        
        // 自动分类
        function autoCategorize(text) {
            const categories = db.exec('SELECT id, name FROM categories');
            const categorySelect = document.getElementById('categorySelect');
            
            if (categories[0]) {
                for (const row of categories[0].values) {
                    const [id, name] = row;
                    const category = db.exec(`SELECT rule FROM categories WHERE id = ${id}`);
                    
                    if (category[0] && category[0].values[0][0]) {
                        const rule = category[0].values[0][0];
                        try {
                            const regex = new RegExp(rule);
                            if (regex.test(text)) {
                                categorySelect.value = id;
                                break;
                            }
                        } catch (e) {
                            console.error('正则表达式错误:', e);
                        }
                    }
                }
            }
        }
        
        // 加载分类
        function loadCategories() {
            const categories = db.exec('SELECT id, name, color, rule FROM categories');
            const categoriesContainer = document.getElementById('categoriesContainer');
            const categorySelect = document.getElementById('categorySelect');
            
            // 清空容器
            categoriesContainer.innerHTML = '';
            categorySelect.innerHTML = '<option value="">请选择分类</option>';
            
            if (categories[0]) {
                for (const row of categories[0].values) {
                    const [id, name, color, rule] = row;
                    
                    // 添加到分类管理界面
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'card bg-white p-4 rounded-lg shadow';
                    categoryCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 rounded-full mr-2" style="background-color: ${color}"></div>
                                    <h4 class="font-medium">${name}</h4>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">${rule || '无规则'}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-category-btn text-blue-600 hover:text-blue-800" data-id="${id}">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-category-btn text-red-600 hover:text-red-800" data-id="${id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    categoriesContainer.appendChild(categoryCard);
                    
                    // 添加到下拉选择
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    categorySelect.appendChild(option);
                }
                
                // 添加编辑和删除事件监听器
                document.querySelectorAll('.edit-category-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = parseInt(btn.dataset.id);
                        editCategory(id);
                    });
                });
                
                document.querySelectorAll('.delete-category-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = parseInt(btn.dataset.id);
                        deleteCategory(id);
                    });
                });
            }
        }
        
        // 编辑分类
        function editCategory(id) {
            const category = db.exec(`SELECT id, name, color, rule FROM categories WHERE id = ${id}`);
            
            if (category[0]) {
                const [rowId, name, color, rule] = category[0].values[0];
                currentCategoryId = rowId;
                
                document.getElementById('modalTitle').textContent = '编辑分类';
                document.getElementById('categoryName').value = name;
                document.getElementById('categoryColor').value = color;
                document.getElementById('categoryRule').value = rule;
                document.getElementById('categoryModal').classList.remove('hidden');
            }
        }
        
        // 删除分类
        function deleteCategory(id) {
            if (confirm('确定要删除这个分类吗？')) {
                db.run(`DELETE FROM categories WHERE id = ${id}`);
                loadCategories();
                loadRecords();
                updateStatistics();
            }
        }
        
        // 保存分类
        function saveCategory() {
            const name = document.getElementById('categoryName').value;
            const color = document.getElementById('categoryColor').value;
            const rule = document.getElementById('categoryRule').value;
            
            if (!name) {
                alert('请输入分类名称');
                return;
            }
            
            if (currentCategoryId) {
                // 更新分类
                db.run('UPDATE categories SET name = ?, color = ?, rule = ? WHERE id = ?', [name, color, rule, currentCategoryId]);
            } else {
                // 添加分类
                db.run('INSERT INTO categories (name, color, rule) VALUES (?, ?, ?)', [name, color, rule]);
            }
            
            document.getElementById('categoryModal').classList.add('hidden');
            loadCategories();
        }
        
        // 加载记录
        function loadRecords() {
            const monthFilter = document.getElementById('monthFilter').value;
            let query = 'SELECT r.id, r.date, r.description, r.amount, c.name as category_name FROM records r LEFT JOIN categories c ON r.category_id = c.id';
            
            if (monthFilter !== 'all') {
                query += ` WHERE r.date LIKE '${monthFilter}%'`;
            }
            
            query += ' ORDER BY r.date DESC';
            
            const records = db.exec(query);
            const tableBody = document.getElementById('recordsTableBody');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            if (records[0] && records[0].values.length > 0) {
                for (const row of records[0].values) {
                    const [id, date, description, amount, category] = row;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${date}</td>
                        <td class="px-6 py-4">${description}</td>
                        <td class="px-6 py-4">${category || '未分类'}</td>
                        <td class="px-6 py-4 text-right font-medium">¥${parseFloat(amount).toFixed(2)}</td>
                        <td class="px-6 py-4 text-right">
                            <button class="edit-record-btn text-blue-600 hover:text-blue-800 mr-2" data-id="${id}">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-record-btn text-red-600 hover:text-red-800" data-id="${id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                }
                
                // 添加编辑和删除事件监听器
                document.querySelectorAll('.edit-record-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = parseInt(btn.dataset.id);
                        editRecord(id);
                    });
                });
                
                document.querySelectorAll('.delete-record-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = parseInt(btn.dataset.id);
                        deleteRecord(id);
                    });
                });
            } else {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无记录</td>';
                tableBody.appendChild(tr);
            }
        }
        
        // 编辑记录
        function editRecord(id) {
            const record = db.exec(`SELECT id, date, description, amount, category_id FROM records WHERE id = ${id}`);
            
            if (record[0]) {
                const [rowId, date, description, amount, categoryId] = record[0].values[0];
                
                // 切换到上传标签
                document.querySelector('.tab-btn[data-tab="upload"]').click();
                
                // 填充表单
                document.getElementById('dateInput').value = date;
                document.getElementById('descriptionInput').value = description;
                document.getElementById('amountInput').value = amount;
                document.getElementById('categorySelect').value = categoryId || '';
                
                // 显示结果容器
                document.getElementById('resultContainer').classList.remove('hidden');
                
                // 修改保存按钮行为
                const saveBtn = document.getElementById('saveRecordBtn');
                saveBtn.dataset.id = rowId;
                saveBtn.textContent = '更新记录';
            }
        }
        
        // 删除记录
        function deleteRecord(id) {
            if (confirm('确定要删除这条记录吗？')) {
                db.run(`DELETE FROM records WHERE id = ${id}`);
                loadRecords();
                updateStatistics();
            }
        }
        
        // 保存记录
        function saveRecord() {
            const date = document.getElementById('dateInput').value;
            const description = document.getElementById('descriptionInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const categoryId = document.getElementById('categorySelect').value;
            const saveBtn = document.getElementById('saveRecordBtn');
            const recordId = saveBtn.dataset.id;
            
            if (!date || !description || isNaN(amount)) {
                alert('请填写完整的记录信息');
                return;
            }
            
            if (recordId) {
                // 更新记录
                db.run('UPDATE records SET date = ?, description = ?, amount = ?, category_id = ? WHERE id = ?', 
                    [date, description, amount, categoryId || null, recordId]);
                saveBtn.textContent = '保存记录';
                delete saveBtn.dataset.id;
            } else {
                // 插入记录
                db.run('INSERT INTO records (date, description, amount, category_id) VALUES (?, ?, ?, ?)', 
                    [date, description, amount, categoryId || null]);
            }
            
            // 重置表单
            document.getElementById('dateInput').value = '';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('amountInput').value = '';
            document.getElementById('categorySelect').value = '';
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            
            // 重新加载数据
            loadRecords();
            updateStatistics();
            
            // 显示成功提示
            alert('记录保存成功');
        }
        
        // 更新统计数据
        function updateStatistics() {
            const monthFilter = document.getElementById('statMonthFilter').value;
            let query = 'SELECT amount, category_id, date FROM records';
            
            if (monthFilter !== 'all') {
                query += ` WHERE date LIKE '${monthFilter}%'`;
            }
            
            const records = db.exec(query);
            const categories = db.exec('SELECT COUNT(*) FROM categories');
            
            // 更新分类数量
            if (categories[0]) {
                document.getElementById('categoryCount').textContent = categories[0].values[0][0];
            }
            
            // 计算总支出和平均支出
            let totalExpense = 0;
            const categoryExpenses = {};
            const monthlyExpenses = {};
            
            if (records[0]) {
                for (const row of records[0].values) {
                    const [amount, categoryId, date] = row;
                    totalExpense += parseFloat(amount);
                    
                    // 按分类统计
                    if (categoryId) {
                        if (!categoryExpenses[categoryId]) {
                            categoryExpenses[categoryId] = 0;
                        }
                        categoryExpenses[categoryId] += parseFloat(amount);
                    }
                    
                    // 按月统计
                    const month = date.substring(0, 7); // YYYY-MM
                    if (!monthlyExpenses[month]) {
                        monthlyExpenses[month] = 0;
                    }
                    monthlyExpenses[month] += parseFloat(amount);
                }
                
                const averageExpense = totalExpense / records[0].values.length;
                document.getElementById('totalExpense').textContent = `¥${totalExpense.toFixed(2)}`;
                document.getElementById('averageExpense').textContent = `¥${averageExpense.toFixed(2)}`;
            } else {
                document.getElementById('totalExpense').textContent = '¥0.00';
                document.getElementById('averageExpense').textContent = '¥0.00';
            }
            
            // 更新分类饼图
            updateCategoryChart(categoryExpenses);
            
            // 更新月度趋势图
            updateTrendChart(monthlyExpenses);
        }
        
        // 更新分类饼图
        function updateCategoryChart(categoryExpenses) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // 销毁现有图表
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }
            
            // 准备数据
            const labels = [];
            const data = [];
            const backgroundColor = [];
            
            for (const [categoryId, amount] of Object.entries(categoryExpenses)) {
                const category = db.exec(`SELECT name, color FROM categories WHERE id = ${categoryId}`);
                
                if (category[0]) {
                    const [name, color] = category[0].values[0];
                    labels.push(name);
                    data.push(amount);
                    backgroundColor.push(color);
                }
            }
            
            // 创建图表
            window.categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // 更新月度趋势���
        function updateTrendChart(monthlyExpenses) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // 销毁现有图表
            if (window.trendChart) {
                window.trendChart.destroy();
            }
            
            // 准备数据
            const labels = Object.keys(monthlyExpenses).sort();
            const data = labels.map(month => monthlyExpenses[month]);
            
            // 创建图表
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '月度支出',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 导出数据
        function exportData() {
            const categories = db.exec('SELECT id, name, color, rule FROM categories');
            const records = db.exec('SELECT id, date, description, amount, category_id FROM records');
            
            const data = {
                categories: [],
                records: []
            };
            
            if (categories[0]) {
                for (const row of categories[0].values) {
                    data.categories.push({
                        id: row[0],
                        name: row[1],
                        color: row[2],
                        rule: row[3]
                    });
                }
            }
            
            if (records[0]) {
                for (const row of records[0].values) {
                    data.records.push({
                        id: row[0],
                        date: row[1],
                        description: row[2],
                        amount: row[3],
                        category_id: row[4]
                    });
                }
            }
            
            // 创建下载链接
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookkeeping_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 处理导入文件
        function handleImportFile(e) {
            const file = e.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        importData(data);
                    } catch (error) {
                        console.error('导入失败:', error);
                        document.getElementById('importStatus').textContent = '导入失败：无效的 JSON 文件';
                        document.getElementById('importStatus').classList.remove('hidden');
                        document.getElementById('importStatus').classList.add('text-red-600');
                    }
                };
                reader.readAsText(file);
            }
        }
        
        // 导入数据
        function importData(data) {
            // 清空现有数据
            db.run('DELETE FROM records');
            db.run('DELETE FROM categories');
            
            // 导入分类
            if (data.categories) {
                for (const category of data.categories) {
                    db.run('INSERT INTO categories (id, name, color, rule) VALUES (?, ?, ?, ?)', 
                        [category.id, category.name, category.color, category.rule]);
                }
            }
            
            // 导入记录
            if (data.records) {
                for (const record of data.records) {
                    db.run('INSERT INTO records (id, date, description, amount, category_id) VALUES (?, ?, ?, ?, ?)', 
                        [record.id, record.date, record.description, record.amount, record.category_id]);
                }
            }
            
            // 更新界面
            loadCategories();
            loadRecords();
            updateStatistics();
            
            // 显示成功消息
            document.getElementById('importStatus').textContent = '导入成功！';
            document.getElementById('importStatus').classList.remove('hidden');
            document.getElementById('importStatus').classList.add('text-green-600');
            
            // 重置文件输入
            document.getElementById('importFileInput').value = '';
        }
        
        // 初始化应用
        window.addEventListener('DOMContentLoaded', init);
    </script>
    <script>
        window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>